name: Manual run (interactive QEMU console)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform name"
        required: true
        default: "virt-cortex-a53"
        type: choice
        options:
          - virt-cortex-a53
          - virt-cortex-a72
          - virt-neoverse-n1
          - virt-cortex-a710
      rebuild:
        description: "Force rebuild even if bundle exists"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]
      runner_label:
        description: "Runner label (leave empty to use repo var RUNNER_LABEL or default ubuntu-24.04)"
        required: false
        default: ""
        type: string
      serial_telnet_port:
        description: "Port for QEMU serial telnet server"
        required: true
        default: 4321
        type: number
      tmate_timeout_minutes:
        description: "How long to keep the tmate session open before auto-continuing"
        required: true
        default: 20
        type: number

jobs:
  run:
    runs-on: ${{ inputs.runner_label || vars.RUNNER_LABEL || 'ubuntu-24.04' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install runtime deps (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            expect cpio gzip tar telnet \
            libglib2.0-0 libpixman-1-0 zlib1g

      # Fetch latest successful CI run artifact from SAME BRANCH
      - name: Install gh
        if: ${{ inputs.rebuild != 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Download latest common bundle from same branch (if available)
        if: ${{ inputs.rebuild != 'true' }}
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p out/artifacts

          echo "Looking for latest successful CI run on branch: ${BRANCH}"

          RUN_ID="$(gh run list \
            --workflow "CI build common + boot smoke test matrix (aarch64 virt)" \
            --branch "${BRANCH}" \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')"

          if [[ -z "${RUN_ID}" || "${RUN_ID}" == "null" ]]; then
            echo "No successful CI run found on branch ${BRANCH}"
            exit 1
          fi

          echo "Using CI run id: ${RUN_ID}"
          gh run download "${RUN_ID}" -n common-bundle -D out/artifacts

      - name: Unpack common bundle if present
        if: ${{ inputs.rebuild != 'true' }}
        run: |
          set -euo pipefail
          mkdir -p out
          B="$(ls -1 out/artifacts/common-*.tgz 2>/dev/null | head -n 1 || true)"
          if [[ -n "${B}" && -f "${B}" ]]; then
            echo "Found common bundle: ${B}"
            tar -C out -xzf "${B}"
            echo "BUNDLE_OK=1" >> "$GITHUB_ENV"
          else
            echo "No common bundle found."
            echo "BUNDLE_OK=0" >> "$GITHUB_ENV"
          fi

      # Build only when needed
      - name: Install build deps
        if: ${{ inputs.rebuild == 'true' || env.BUNDLE_OK != '1' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential ninja-build pkg-config \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            flex bison bc libssl-dev libncurses-dev \
            python3 python3-yaml telnet \
            libglib2.0-dev libpixman-1-dev zlib1g-dev \
            expect cpio gzip curl tar xz-utils

      - name: Build all (only if needed)
        if: ${{ inputs.rebuild == 'true' || env.BUNDLE_OK != '1' }}
        env:
          PLATFORM: ${{ inputs.platform }}
        run: |
          bash scripts/build_all.sh

      - name: Start QEMU (telnet serial, background)
        env:
          PLATFORM: ${{ inputs.platform }}
          SERIAL_TELNET_PORT: ${{ inputs.serial_telnet_port }}
        run: |
          set -euo pipefail
          mkdir -p out
          echo "Starting QEMU with telnet serial on port ${SERIAL_TELNET_PORT}"
          bash -lc "PLATFORM=${PLATFORM} SERIAL_TELNET_PORT=${SERIAL_TELNET_PORT} bash scripts/run_qemu.sh > out/qemu.log 2>&1 & echo \$! > out/qemu.pid"
          sleep 2
          if ! kill -0 "$(cat out/qemu.pid)" 2>/dev/null; then
            echo "QEMU failed to start (pid file missing or process not running)" >&2
            cat out/qemu.log || true
            exit 1
          fi

      - name: Prepare auto-connect tmate (telnet to QEMU serial)
        env:
          SERIAL_TELNET_PORT: ${{ inputs.serial_telnet_port }}
        run: |
          cat > ~/.tmate.conf <<EOF
set -g default-command "bash -lc 'telnet 127.0.0.1 ${SERIAL_TELNET_PORT}'"
EOF

      - name: Interactive session (tmate -> QEMU serial)
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
        timeout-minutes: ${{ inputs.tmate_timeout_minutes }}

      - name: Stop QEMU
        if: always()
        run: |
          set -euo pipefail
          if [[ -f out/qemu.pid ]]; then
            PID="$(cat out/qemu.pid)"
            if kill -0 "${PID}" 2>/dev/null; then
              kill "${PID}" || true
              sleep 2
              if kill -0 "${PID}" 2>/dev/null; then
                kill -9 "${PID}" || true
              fi
            fi
          fi

      - name: Upload qemu log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-log-${{ inputs.platform }}
          path: out/qemu.log
