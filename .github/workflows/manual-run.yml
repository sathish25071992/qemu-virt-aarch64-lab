name: Manual run (interactive QEMU console)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform name"
        required: true
        default: "virt-cortex-a53"
        type: choice
        options:
          - virt-cortex-a53
          - virt-cortex-a72
          - virt-neoverse-n1
          - virt-cortex-a710
      rebuild:
        description: "Force rebuild even if bundle exists"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]
      runner_label:
        description: "Runner label (leave empty to use repo var RUNNER_LABEL or default ubuntu-24.04)"
        required: false
        default: ""
        type: string
      serial_telnet_port:
        description: "Port for QEMU serial telnet server"
        required: true
        default: 4321
        type: number
      boot_chain:
        description: "Boot chain"
        required: true
        default: "linux"
        type: choice
        options: ["linux", "atf"]

jobs:
  run:
    runs-on: ${{ inputs.runner_label || vars.RUNNER_LABEL || 'ubuntu-24.04' }}
    env:
      BUNDLE_OK: "0"
    steps:
      - uses: actions/checkout@v4

      - name: Install runtime deps (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            expect cpio gzip tar telnet \
            libglib2.0-0 libpixman-1-0 zlib1g

      # Fetch latest successful CI run artifact from SAME BRANCH
      - name: Install gh
        if: ${{ inputs.rebuild != 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Download latest common bundle from same branch (if available)
        if: ${{ inputs.rebuild != 'true' }}
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p out/artifacts

          echo "Looking for latest successful CI run on branch: ${BRANCH}"

          RUN_ID="$(gh run list \
            --workflow "CI build common + boot smoke test matrix (aarch64 virt)" \
            --branch "${BRANCH}" \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')"

          if [[ -z "${RUN_ID}" || "${RUN_ID}" == "null" ]]; then
            echo "No successful CI run found on branch ${BRANCH}"
            exit 1
          fi

          echo "Using CI run id: ${RUN_ID}"
          gh run download "${RUN_ID}" -n common-bundle -D out/artifacts

      - name: Unpack common bundle if present
        if: ${{ inputs.rebuild != 'true' }}
        run: |
          set -euo pipefail
          mkdir -p out
          B="$(ls -1 out/artifacts/common-*.tgz 2>/dev/null | head -n 1 || true)"
          if [[ -n "${B}" && -f "${B}" ]]; then
            echo "Found common bundle: ${B}"
            tar -C out -xzf "${B}"
            echo "BUNDLE_OK=1" >> "$GITHUB_ENV"
          else
            echo "No common bundle found."
            echo "BUNDLE_OK=0" >> "$GITHUB_ENV"
          fi

      # Build only when needed
      - name: Install build deps
        if: ${{ inputs.rebuild == 'true' || env.BUNDLE_OK != '1' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential ninja-build pkg-config \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            flex bison bc libssl-dev libncurses-dev \
            python3 python3-yaml telnet \
            libglib2.0-dev libpixman-1-dev zlib1g-dev \
            expect cpio gzip curl tar xz-utils

      - name: Build all (only if needed)
        if: ${{ inputs.rebuild == 'true' || env.BUNDLE_OK != '1' }}
        env:
          PLATFORM: ${{ inputs.platform }}
        run: |
          bash scripts/build_all.sh

      - name: Prepare auto-connect tmate (auto-start QEMU)
        env:
          PLATFORM: ${{ inputs.platform }}
          SERIAL_TELNET_PORT: ${{ inputs.serial_telnet_port }}
          BOOT_CHAIN: ${{ inputs.boot_chain }}
        run: |
          set -euo pipefail
          mkdir -p out
          P="${PLATFORM:-}"
          PORT="${SERIAL_TELNET_PORT:-4321}"
          {
            echo "PLATFORM=${P}"
            echo "SERIAL_TELNET_PORT=${PORT}"
          } >> "$GITHUB_ENV"

          cat > /tmp/qemu-serial-connect.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          PIDFILE="out/qemu.pid"
          LOGFILE="out/qemu.log"

          PLATFORM_VALUE="${PLATFORM:?PLATFORM not set}"
          SERIAL_TELNET_PORT_VALUE="${SERIAL_TELNET_PORT:-4321}"

          start_qemu() {
            if [[ -f "${PIDFILE}" ]] && kill -0 "$(cat "${PIDFILE}")" 2>/dev/null; then
              echo "QEMU already running (pid $(cat "${PIDFILE}"))"
              return
            fi
            echo "Launching QEMU (platform=${PLATFORM_VALUE}, telnet port=${SERIAL_TELNET_PORT_VALUE})"
            PLATFORM="${PLATFORM_VALUE}" BOOT_CHAIN=${BOOT_CHAIN} SERIAL_TELNET_PORT="${SERIAL_TELNET_PORT_VALUE}" \
              bash scripts/run_qemu.sh > "${LOGFILE}" 2>&1 &
            echo $! > "${PIDFILE}"
          }

          wait_qemu() {
            for _ in {1..20}; do
              if [[ -f "${PIDFILE}" ]] && kill -0 "$(cat "${PIDFILE}")" 2>/dev/null; then
                echo "QEMU running (pid $(cat "${PIDFILE}"))"
                return 0
              fi
              sleep 1
            done
            echo "QEMU failed to start or stay running. Log tail:" >&2
            tail -n 200 "${LOGFILE}" >&2 || true
            exit 1
          }

          start_qemu
          wait_qemu
          sleep 10
          exec telnet 127.0.0.1 "${SERIAL_TELNET_PORT_VALUE}"
          EOF

          chmod +x /tmp/qemu-serial-connect.sh
          cat > ~/.tmate.conf <<'EOF'
          set -g default-command "/tmp/qemu-serial-connect.sh"
          EOF

          # Optional fallback: if default-command isn't honored in some shells
          echo '[[ -t 0 && -z "${TMATE_QEMU_DONE:-}" ]] && export TMATE_QEMU_DONE=1 && exec /tmp/qemu-serial-connect.sh' >> ~/.bashrc

      - name: Interactive session (tmate -> QEMU serial)
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
        timeout-minutes: 60

      - name: Stop QEMU
        if: always()
        run: |
          set -euo pipefail
          if [[ -f out/qemu.pid ]]; then
            PID="$(cat out/qemu.pid)"
            if kill -0 "${PID}" 2>/dev/null; then
              kill "${PID}" || true
              sleep 2
              if kill -0 "${PID}" 2>/dev/null; then
                kill -9 "${PID}" || true
              fi
            fi
          fi

      - name: Upload qemu log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-log-${{ inputs.platform }}
          path: out/qemu.log
